pipeline {
    agent any
    environment {
        ECR_REPO = "${env.ECR_URL}"
        AWS_REGION = 'us-west-2'
        DOCKER_BUILDKIT = '0'
    }
    stages {
        stage('Debug Environment') {  
            steps {
                 sh '''
                    echo "=== Environment Variables ==="
                    echo "ECR_REPO: $ECR_REPO"
                    echo "ECR_URL: $ECR_URL"
                    echo "AWS_REGION: $AWS_REGION"
                    echo "BUILD_NUMBER: $BUILD_NUMBER"
                    
                    echo "=== Docker Info ==="
                    docker info
                    
                    echo "=== AWS ECR Login Test ==="
                    aws ecr get-login-password --region ${AWS_REGION} || echo "ECR login failed"
                    
                    echo "=== Directory Structure ==="
                    ls -la
                '''
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Build') {
            steps {
                dir('app') {
                    script {
                     sh '''
                    echo "=== Building Docker Image ==="
                    echo "Building image: ${ECR_REPO}:${BUILD_NUMBER}"
                    docker build -t ${ECR_REPO}:${BUILD_NUMBER} --pull .
                    echo "=== Image Built Successfully ==="
                    docker images | grep ${ECR_REPO}
                    '''  
                    }
                }
            }
        }
        stage('Push') {
            steps {
                script {
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${env.ECR_URL}
                        docker push ${env.ECR_URL}:${env.BUILD_NUMBER}
                        docker push ${env.ECR_URL}:latest
                    """
                }
            }
        }
        stage('Update Deployment') {
            steps {
                script {
                    sh """
                        aws ssm put-parameter \
                        --region ${AWS_REGION} \
                        --name "/ml-inference/latest-image" \
                        --value "${env.ECR_URL}:${env.BUILD_NUMBER}" \
                        --type String \
                        --overwrite
                    """
                }
            }
        }
    }
    post {
        always {
            sh """
                docker rmi ${env.ECR_URL}:${env.BUILD_NUMBER} || true
                docker rmi ${env.ECR_URL}:latest || true
            """
        }
    }
}
